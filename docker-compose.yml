version: "2.4"

services:
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    ports:
      - "8080:80"
      - "4000:4000"
    environment:
      - HOST_LOCAL=localhost
      - HOST_EXTERNAL=10.13.3.5
      - BACKEND_HOST=gateway
      - BACKEND_PORT=4000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=5173
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    networks:
      - web
  redis:
    image: redis/redis-stack-server:latest
    container_name: redis
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - web

  rabbitmq:
    image: rabbitmq
    container_name: rabbitmq
    networks:
      - web
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    image: frontend:latest
    build: ./frontend
    container_name: frontend
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    env_file:
      - ./frontend/.env
    volumes:
      - ./frontend:/frontend
      - /frontend/node_modules
    networks:
      - web
  gateway:
    build: ./backend/gateway
    image: gateway-image
    container_name: gateway
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "npm run dev"
    volumes:
      - ./frontend/src/uploads:/tmp/
      - ./backend/gateway/src:/gateway/src
    env_file:
      - ./backend/gateway/.env
    networks:
      - web

  auth:
    build: ./backend/services/auth
    image: auth-image
    container_name: auth
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"
    env_file:
      - ./backend/services/auth/.env
    ports:
      - "5001:5555"
    volumes:
      - ./uploads/user/:/auth/uploads/
      - ./backend/services/auth/src:/auth/src
      - ./backend/services/auth/prisma:/auth/prisma
    networks:
      - web

  user:
    build: ./backend/services/user
    image: user-image
    container_name: user
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"
    env_file:
      - ./backend/services/user/.env
    ports:
      - "5002:5555"
    volumes:
      - ./backend/services/user/uploads:/user/uploads
      - ./backend/services/user/src:/user/src
      - ./backend/services/user/prisma:/user/prisma
    networks:
      - web

  notify:
    build: ./backend/services/notify
    image: notify-image
    container_name: notify
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"
    env_file:
      - ./backend/services/notify/.env
    ports:
      - "5004:5555"
    volumes:
      - ./backend/services/notify/src:/notify/src
      - ./backend/services/notify/prisma:/notify/prisma
    networks: 
      - web

  chat:
    build: ./backend/services/chat
    image: chat-image
    container_name: chat
    restart: always
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"

    env_file:
      - ./backend/services/chat/.env
    ports:
      - "5003:5555"
    volumes:
      - ./uploads/chat/:/chat/uploads
      - ./backend/services/chat/src:/chat/src
      - ./backend/services/chat/prisma:/chat/prisma
    networks: 
      - web

  game:
    build: ./backend/services/game
    image: game-image
    container_name: game
    restart: always
    command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"
    env_file:
      - ./backend/services/game/.env
    ports:
      - "4005:4005"
      - "5005:5555"
    volumes:
      - ./backend/services/game/src:/game/src
      - ./backend/services/game/prisma:/game/prisma
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks: 
      - web
  # tournament:
  #   build: ./backend/services/tournament
  #   image: tournament-image
  #   container_name: tournament
  #   restart: always
  #   command: sh -c "npx prisma db push  && npx prisma studio  & npm run dev"
  #   env_file:
  #     - ./backend/services/tournament/.env
  #   ports:
  #     - "5006:5555"
  #   volumes:
  #     - ./backend/services/tournament/src:/tournament/src
  #     - ./backend/services/tournament/prisma:/tournament/prisma
  #   depends_on:
  #     rabbitmq:
  #       condition: service_healthy
  #   networks: 
  #     - web

networks:
  web:
    driver: bridge
